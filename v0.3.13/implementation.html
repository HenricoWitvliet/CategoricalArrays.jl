<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Implementation details · CategoricalArrays</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link href="assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><a href="index.html"><img class="logo" src="assets/logo.png" alt="CategoricalArrays logo"/></a><h1>CategoricalArrays</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="search.html"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="index.html">Overview</a></li><li><a class="toctext" href="using.html">Using CategoricalArrays</a></li><li class="current"><a class="toctext" href="implementation.html">Implementation details</a><ul class="internal"></ul></li><li><a class="toctext" href="functionindex.html">Index</a></li></ul></nav><article id="docs"><header><nav><ul><li><a href="implementation.html">Implementation details</a></li></ul><a class="edit-page" href="https://github.com/JuliaData/CategoricalArrays.jl/blob/master/docs/src/implementation.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>Implementation details</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Implementation-details-1" href="#Implementation-details-1">Implementation details</a></h1><p><code>CategoricalArray</code> is made of the two fields:</p><ul><li><p><code>refs</code>: an integer array that stores the position of the category level in the <code>index</code> field of <code>CategoricalPool</code> for each <code>CategoricalArray</code> element; <code>0</code> denotes a missing value (for <code>CategoricalArray{Union{T, Missing}}</code> only).</p></li><li><p><code>pool</code>: the <code>CategoricalPool</code> object that maintains the levels of the array.</p></li></ul><p>The <code>CategoricalPool{V,R,C}</code> type keeps track of the levels of type <code>V</code> and associates them with an integer reference code of type <code>R</code> (for internal use). It offers methods to set the levels, change their order while preserving the references, and efficiently get the integer index corresponding to a level and vice-versa. Whether the values of <code>CategoricalArray</code> are ordered or not is defined by an <code>ordered</code> field of the pool. Finally, <code>CategoricalPool</code> keeps a <code>valindex</code> vector of value objects of type <code>C</code> (<code>CategoricalString{R}</code> or <code>CategoricalValue{V, R}</code>), so that <code>getindex</code> can return the existing object instead of allocating a new one.</p><p>The type parameters of <code>CategoricalArray{T, N, R &lt;: Integer, V, C, U}</code> are a bit complex:</p><ul><li><p><code>T</code> is the type of array elements without <code>CategoricalString</code>/<code>CategoricalValue</code> wrappers; if <code>T &gt;: Missing</code>, then the array supports missing values.</p></li><li><p><code>N</code> is the number of array dimensions.</p></li><li><p><code>R</code> is the reference type, the element type of the <code>refs</code> field; it allows optimizing memory usage depending on the number of levels (i.e. <code>CategoricalArray</code> with less than 256 levels can use <code>R = UInt8</code>).</p></li><li><p><code>V</code> is the type of the levels, it is equal to <code>T</code> for arrays which do not support missing values; for arrays which support missing values, <code>T = Union{V, Missing}</code></p></li><li><p><code>C</code> is the type of categorical values, i.e. the objects returned when indexing non-missing elements of <code>CategoricalArray</code>. <code>C</code> is <code>CategoricalString{R}</code> if <code>V = String</code> and <code>CategoricalValue{V, R}</code> for any other <code>V</code>.</p></li><li><p><code>U</code> can be either <code>Union{}</code> for arrays which do not support missing values, or <code>Missing</code> for those which support them.</p></li></ul><p>Only <code>T</code>, <code>N</code> and <code>R</code> could be specified upon construction. The last three parameters are chosen automatically, but are needed for the definition of the type. In particular, <code>U</code> allows expressing that <code>CategoricalArray{T, N}</code> inherits from <code>AbstractArray{Union{C, U}, N}</code> (which is equivalent to <code>AbstractArray{C, N}</code> for arrays which do not support missing values, and to <code>AbstractArray{Union{C, Missing}, N}</code> for those which support them).</p><p>The <code>CategoricalPool</code> type is designed to limit the need to go over all elements of the vector, either for reading or for writing. This is why unused levels are not dropped automatically (this would force checking all elements on every modification or keeping a counts table), but only when <code>droplevels!</code> is called. <code>levels</code> is a (very fast) O(1) operation since it merely returns the (ordered) vector of levels without accessing the data at all.</p><p>Another useful feature is that integer indices referring to levels are preserved when adding or reordering levels: the order of levels exposed to the user by the <code>levels</code> function does not necessarily match these internal indices, which are stored in the <code>index</code> field of the pool. This means a reordering of the levels is also an O(1) operation. On the other hand, deleting levels may change the indices and therefore requires iterating over all elements in the array to update the references.</p><footer><hr/><a class="previous" href="using.html"><span class="direction">Previous</span><span class="title">Using CategoricalArrays</span></a><a class="next" href="functionindex.html"><span class="direction">Next</span><span class="title">Index</span></a></footer></article></body></html>
